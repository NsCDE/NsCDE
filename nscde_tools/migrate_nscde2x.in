#!@KSH@

cd "$HOME/.NsCDE"
if (( $? != 0)); then
   echo "Error: cannot change directory to $HOME/.NsCDE"
   exit 4
fi

ISED="$NSCDE_TOOLSDIR/ised"

function backup_current_dot_nscde
{
   if [ -d "$HOME/.NsCDE" ]; then
      confdir_size=$(du -k "$HOME/.NsCDE")
      if (( $confdir_size > 204800 )); then
         echo "Error: your $HOME/.NsCDE directory has more then 200 MB. Something appears to be"
         echo "wrong with your NsCDE profile. Examine your profile, or back it up manually, and"
         echo "rerun migration script like \"$0 -B\"."
         exit 2
      else
         stamp=$(date +%d-%m-%Y-%H-%M-%S)
         cd "$HOME" && tar cpf dot_NsCDE_${stamp}.tar .NsCDE
         RETVAL1=$?
         if (($RETVAL1 == 0)); then
            echo "Backup copy of $HOME/.NsCDE saved as $HOME/dot_NsCDE_${stamp}.tar."
         else
            echo "Error: backing up $HOME/.NsCDE exited with exit status ${RETVAL1}."
            exit 3
         fi
      fi
   fi
}

function rename_config_files
{
   old_confs="NsCDE-Backer.conf NsCDE-Event.conf NsCDE-FinishInit.conf NsCDE-Form.conf NsCDE-FrontPanel.conf NsCDE-Functions.conf NsCDE-IconMan.conf NsCDE-Ident.conf NsCDE-Init.conf NsCDE-Keybindings.conf NsCDE-Main.conf NsCDE-Menus.conf NsCDE-Monitors.conf NsCDE-Mousebindings.conf NsCDE-Pager-LocalPager.conf NsCDE-Pager-WspLocPager.conf NsCDE-Sandbox.conf NsCDE-Script.conf NsCDE-Style.conf"

   old_genconfs="NsCDE-Animate.conf NsCDE-Backdrops.conf NsCDE-Colorset.conf NsCDE-Font-120dpi.conf NsCDE-Font-144dpi.conf NsCDE-Font-192dpi.conf NsCDE-Font-75dpi.conf NsCDE-Font-96dpi.conf"

   old_locals="NsCDE-Animate.local NsCDE-Backdrops.local NsCDE-Backer.local NsCDE-Colorset.local NsCDE-Event.local NsCDE-FinishInit.local NsCDE-Font-120dpi.local NsCDE-Font-144dpi.local NsCDE-Font-192dpi.local NsCDE-Font-75dpi.local NsCDE-Font-96dpi.local NsCDE-Form.local NsCDE-FrontPanel.local NsCDE-Functions.local NsCDE-IconMan.local NsCDE-Ident.local NsCDE-Init.local NsCDE-Keybindings.local NsCDE-Main.local NsCDE-Menus.local NsCDE-Monitors.local NsCDE-Mousebindings.local NsCDE-Pager-LocalPager.local NsCDE-Pager-WspLocPager.local NsCDE-Sandbox.local NsCDE-Script.local NsCDE-Style.local NsCDE-Subpanels.local"

   # Will be regenerated upon restart
   rm -f "NsCDE-Subpanels.conf"

   for oc in $old_confs
   do
      new_oc1="${oc##*NsCDE-}"
      new_oc2="${new_oc1/.conf/.fvwmconf}"
      new_oc="${new_oc2}"

      if [ -r "$HOME/.NsCDE/${oc}" ] [ -h "$HOME/.NsCDE/${oc}" ]; then
         echo "Renaming $oc to $new_oc ..."
         mv -f "$oc" "$new_oc"
         RETVAL=$?
         if (($RETVAL != 0)); then
            echo "Error: Renaming ${oc} to ${new_oc} returned error ${RETVAL}."
         fi
      fi
   done

   for og in $old_genconfs
   do
      new_og1="${og##*NsCDE-}"
      new_og2="${new_og1/.conf/.fvwmgen}"
      new_og="${new_og2}"

      if [ -r "$HOME/.NsCDE/${og}" ] || [ -h "$HOME/.NsCDE/${og}" ]; then
         echo "Renaming $og to $new_og ..."
         mv -f "$og" "$new_og"
         RETVAL=$?
         if (($RETVAL != 0)); then
            echo "Error: Renaming ${og} to ${new_og} returned error ${RETVAL}."
         fi
      fi
   done

   for ol in $old_locals
   do
      new_ol1="${ol##*NsCDE-}"
      new_ol2="${new_ol1/.local/.fvwmlocal}"
      new_ol="${new_ol2}"

      if [ -r "$HOME/.NsCDE/${ol}" ] || [ -h "$HOME/.NsCDE/${ol}" ]; then
         echo "Renaming $ol to $new_ol ..."
         mv -f "$ol" "$new_ol"
         RETVAL=$?
         if (($RETVAL != 0)); then
            echo "Error: Renaming ${ol} to ${new_ol} returned error ${RETVAL}."
         fi
      fi
   done

   # Relink fontsets
   for fo in Font-*dpi.fvwmgen
   do
      if [ -L "${fo}" ]; then
         base_fontset=$(readlink ${fo})
         if [ ! -f "fontsets/${base_fontset##*/}" ]; then
            if [ -f "${NSCDE_DATADIR}/fontsets/${base_fontset##*/}" ]; then
              echo "Relinking ${fo} to ${NSCDE_DATADIR}/fontsets/${base_fontset##*/}."
              ln -sf "${NSCDE_DATADIR}/fontsets/${base_fontset##*/}" "${fo}"
            fi
         fi
      fi
   done
}

function replace_pathnames_in_files
{
   # Start with bin
   cat "$1" | $ISED -c 's/\$NSCDE_ROOT\/bin\/confget\.py/\$NSCDE_TOOLSDIR\/confget/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/bin\/confget\.py/\${NSCDE_TOOLSDIR}\/confget/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/bin\/confget\.py/\$NSCDE_TOOLSDIR\/confget/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/bin\/confget\.py/\$\[NSCDE_TOOLSDIR\]\/confget/g' -o -f - > /tmp/_migrate_tmp0.$$

   cat /tmp/_migrate_tmp0.$$ | $ISED -c 's/\$NSCDE_ROOT\/bin\/confset\.py/\$NSCDE_TOOLSDIR\/confset/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/bin\/confset\.py/\${NSCDE_TOOLSDIR}\/confset/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/bin\/confset\.py/\$NSCDE_TOOLSDIR\/confset/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/bin\/confset\.py/\$\[NSCDE_TOOLSDIR\]\/confset/g' -o -f - > /tmp/_migrate_tmp1.$$

   OSMACH=$(uname -sm | tr ' ' '_')
   cat /tmp/_migrate_tmp1.$$ | $ISED -c "s/\$NSCDE_ROOT\/bin\/fpclock-$OSMACH/\$NSCDE_LIBDIR\/$OSMACH\/fpclock/g" -o -f - | \
   $ISED -c "s/\${NSCDE_ROOT}\/bin\/fpclock-$OSMACH/\${NSCDE_LIBDIR}\/$OSMACH\/fpclock/g" -o -f - | \
   $ISED -c "s/\/opt\/NsCDE\/bin\/fpclock-$OSMACH/\$NSCDE_LIBDIR\/$OSMACH\/fpclock/g" -o -f - | \
   $ISED -c "s/\$\[NSCDE_ROOT\]\/bin\/fpclock-$OSMACH/\$\[NSCDE_LIBDIR\]\/$OSMACH\/fpclock/g" -o -f - > /tmp/_migrate_tmp0.$$

   cat /tmp/_migrate_tmp0.$$ | $ISED -c "s/\$NSCDE_ROOT\/bin\/fpclock-\$(uname -s)_\$(uname -m)/\$NSCDE_LIBDIR\/$OSMACH\/fpclock/g" -o -f - | \
   $ISED -c "s/\${NSCDE_ROOT}\/bin\/fpclock-\$(uname -s)_\$(uname -m)/\${NSCDE_LIBDIR}\/$OSMACH\/fpclock/g" -o -f - | \
   $ISED -c "s/\/opt\/NsCDE\/bin\/fpclock-\$(uname -s)_\$(uname -m)/\$NSCDE_LIBDIR\/$OSMACH\/fpclock/g" -o -f - | \
   $ISED -c "s/\$\[NSCDE_ROOT\]\/bin\/fpclock-\$(uname -s)_\$(uname -m)/\$\[NSCDE_LIBDIR\]\/$OSMACH\/fpclock/g" -o -f - > /tmp/_migrate_tmp1.$$

   cat /tmp/_migrate_tmp1.$$ | $ISED -c 's/\$NSCDE_ROOT\/bin\/fpclock/\$NSCDE_TOOLSDIR\/fpclock/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/bin\/fpclock/\${NSCDE_TOOLSDIR}\/fpclock/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/bin\/fpclock/\$NSCDE_TOOLSDIR\/fpclock/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/bin\/fpclock/\$\[NSCDE_TOOLSDIR\]\/fpclock/g' -o -f - > /tmp/_migrate_tmp0.$$

   cat /tmp/_migrate_tmp0.$$ | $ISED -c 's/\$NSCDE_ROOT\/bin\/getdpi/\$NSCDE_TOOLSDIR\/getdpi/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/bin\/getdpi/\${NSCDE_TOOLSDIR}\/getdpi/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/bin\/getdpi/\$NSCDE_TOOLSDIR\/getdpi/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/bin\/getdpi/\$\[NSCDE_TOOLSDIR\]\/getdpi/g' -o -f - > /tmp/_migrate_tmp1.$$

   cat /tmp/_migrate_tmp1.$$ | $ISED -c 's/\$NSCDE_ROOT\/bin\/getfont/\$NSCDE_TOOLSDIR\/getfont/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/bin\/getfont/\${NSCDE_TOOLSDIR}\/getfont/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/bin\/getfont/\$NSCDE_TOOLSDIR\/getfont/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/bin\/getfont/\$\[NSCDE_TOOLSDIR\]\/getfont/g' -o -f - > /tmp/_migrate_tmp0.$$

   cat /tmp/_migrate_tmp0.$$ | $ISED -c 's/\$NSCDE_ROOT\/bin\/ised/\$NSCDE_TOOLSDIR\/ised/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/bin\/ised/\${NSCDE_TOOLSDIR}\/ised/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/bin\/ised/\$NSCDE_TOOLSDIR\/ised/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/bin\/ised/\$\[NSCDE_TOOLSDIR\]\/ised/g' -o -f - > /tmp/_migrate_tmp1.$$

   cat /tmp/_migrate_tmp1.$$ | $ISED -c 's/\$NSCDE_ROOT\/bin\/mkpagemenu/\$NSCDE_TOOLSDIR\/mkpagemenu/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/bin\/mkpagemenu/\${NSCDE_TOOLSDIR}\/mkpagemenu/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/bin\/mkpagemenu/\$NSCDE_TOOLSDIR\/mkpagemenu/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/bin\/mkpagemenu/\$\[NSCDE_TOOLSDIR\]\/mkpagemenu/g' -o -f - > /tmp/_migrate_tmp0.$$

   cat /tmp/_migrate_tmp0.$$ | $ISED -c 's/\$NSCDE_ROOT\/bin\/nscde_colorpicker/\$NSCDE_TOOLSDIR\/colorpicker/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/bin\/nscde_colorpicker/\${NSCDE_TOOLSDIR}\/colorpicker/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/bin\/nscde_colorpicker/\$NSCDE_TOOLSDIR\/colorpicker/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/bin\/nscde_colorpicker/\$\[NSCDE_TOOLSDIR\]\/colorpicker/g' -o -f - > /tmp/_migrate_tmp1.$$

   cat /tmp/_migrate_tmp1.$$ | $ISED -c 's/\$NSCDE_ROOT\/bin\/nscde_usleep/\$NSCDE_TOOLSDIR\/usleep/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/bin\/nscde_usleep/\${NSCDE_TOOLSDIR}\/usleep/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/bin\/nscde_usleep/\$NSCDE_TOOLSDIR\/usleep/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/bin\/nscde_usleep/\$\[NSCDE_TOOLSDIR\]\/usleep/g' -o -f - > /tmp/_migrate_tmp0.$$

   cat /tmp/_migrate_tmp0.$$ | $ISED -c 's/\$NSCDE_ROOT\/bin\/nscde_var_append/\$NSCDE_TOOLSDIR\/var_append/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/bin\/nscde_var_append/\${NSCDE_TOOLSDIR}\/var_append/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/bin\/nscde_var_append/\$NSCDE_TOOLSDIR\/var_append/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/bin\/nscde_var_append/\$\[NSCDE_TOOLSDIR\]\/var_append/g' -o -f - > /tmp/_migrate_tmp1.$$

   cat /tmp/_migrate_tmp1.$$ | $ISED -c 's/\$NSCDE_ROOT\/bin\/sysinfo\.py/\$NSCDE_TOOLSDIR\/sysinfo/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/bin\/sysinfo\.py/\${NSCDE_TOOLSDIR}\/sysinfo/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/bin\/sysinfo\.py/\$NSCDE_TOOLSDIR\/sysinfo/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/bin\/sysinfo\.py/\$\[NSCDE_TOOLSDIR\]\/sysinfo/g' -o -f - > /tmp/_migrate_tmp0.$$

   cat /tmp/_migrate_tmp0.$$ | $ISED -c 's/\$NSCDE_ROOT\/bin\/xdowrapper/\$NSCDE_TOOLSDIR\/xdowrapper/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/bin\/xdowrapper/\${NSCDE_TOOLSDIR}\/xdowrapper/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/bin\/xdowrapper/\$NSCDE_TOOLSDIR\/xdowrapper/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/bin\/xdowrapper/\$\[NSCDE_TOOLSDIR\]\/xdowrapper/g' -o -f - > /tmp/_migrate_tmp1.$$

   # Libexec
   cat /tmp/_migrate_tmp1.$$ | $ISED -c 's/\$NSCDE_ROOT\/libexec\/appfinder/\$NSCDE_TOOLSDIR\/appfinder/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/libexec\/appfinder/\${NSCDE_TOOLSDIR}\/appfinder/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/libexec\/appfinder/\$NSCDE_TOOLSDIR\/appfinder/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/libexec\/appfinder/\$\[NSCDE_TOOLSDIR\]\/appfinder/g' -o -f - > /tmp/_migrate_tmp0.$$

   cat /tmp/_migrate_tmp0.$$ | $ISED -c 's/\$NSCDE_ROOT\/libexec\/backdropmgr/\$NSCDE_TOOLSDIR\/backdropmgr/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/libexec\/backdropmgr/\${NSCDE_TOOLSDIR}\/backdropmgr/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/libexec\/backdropmgr/\$NSCDE_TOOLSDIR\/backdropmgr/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/libexec\/backdropmgr/\$\[NSCDE_TOOLSDIR\]\/backdropmgr/g' -o -f - > /tmp/_migrate_tmp1.$$

   cat /tmp/_migrate_tmp1.$$ | $ISED -c 's/\$NSCDE_ROOT\/libexec\/colormgr/\$NSCDE_TOOLSDIR\/colormgr/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/libexec\/colormgr/\${NSCDE_TOOLSDIR}\/colormgr/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/libexec\/colormgr/\$NSCDE_TOOLSDIR\/colormgr/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/libexec\/colormgr/\$\[NSCDE_TOOLSDIR\]\/colormgr/g' -o -f - > /tmp/_migrate_tmp0.$$

   cat /tmp/_migrate_tmp0.$$ | $ISED -c 's/\$NSCDE_ROOT\/libexec\/fontmgr/\$NSCDE_TOOLSDIR\/fontmgr/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/libexec\/fontmgr/\${NSCDE_TOOLSDIR}\/fontmgr/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/libexec\/fontmgr/\$NSCDE_TOOLSDIR\/fontmgr/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/libexec\/fontmgr/\$\[NSCDE_TOOLSDIR\]\/fontmgr/g' -o -f - > /tmp/_migrate_tmp1.$$

   cat /tmp/_migrate_tmp1.$$ | $ISED -c 's/\$NSCDE_ROOT\/libexec\/fpexec/\$NSCDE_TOOLSDIR\/fpexec/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/libexec\/fpexec/\${NSCDE_TOOLSDIR}\/fpexec/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/libexec\/fpexec/\$NSCDE_TOOLSDIR\/fpexec/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/libexec\/fpexec/\$\[NSCDE_TOOLSDIR\]\/fpexec/g' -o -f - > /tmp/_migrate_tmp0.$$

   cat /tmp/_migrate_tmp0.$$ | $ISED -c 's/\$NSCDE_ROOT\/libexec\/fp_manage_subpanel/\$NSCDE_TOOLSDIR\/fp_manage_subpanel/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/libexec\/fp_manage_subpanel/\${NSCDE_TOOLSDIR}\/fp_manage_subpanel/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/libexec\/fp_manage_subpanel/\$NSCDE_TOOLSDIR\/fp_manage_subpanel/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/libexec\/fp_manage_subpanel/\$\[NSCDE_TOOLSDIR\]\/fp_manage_subpanel/g' -o -f - > /tmp/_migrate_tmp1.$$

   cat /tmp/_migrate_tmp1.$$ | $ISED -c 's/\$NSCDE_ROOT\/libexec\/fpseticon/\$NSCDE_TOOLSDIR\/fpseticon/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/libexec\/fpseticon/\${NSCDE_TOOLSDIR}\/fpseticon/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/libexec\/fpseticon/\$NSCDE_TOOLSDIR\/fpseticon/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/libexec\/fpseticon/\$\[NSCDE_TOOLSDIR\]\/fpseticon/g' -o -f - > /tmp/_migrate_tmp0.$$

   cat /tmp/_migrate_tmp0.$$ | $ISED -c 's/\$NSCDE_ROOT\/libexec\/generate_app_menus/\$NSCDE_TOOLSDIR\/generate_app_menus/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/libexec\/generate_app_menus/\${NSCDE_TOOLSDIR}\/generate_app_menus/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/libexec\/generate_app_menus/\$NSCDE_TOOLSDIR\/generate_app_menus/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/libexec\/generate_app_menus/\$\[NSCDE_TOOLSDIR\]\/generate_app_menus/g' -o -f - > /tmp/_migrate_tmp1.$$

   cat /tmp/_migrate_tmp1.$$ | $ISED -c 's/\$NSCDE_ROOT\/libexec\/generate_subpanels/\$NSCDE_TOOLSDIR\/generate_subpanels/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/libexec\/generate_subpanels/\${NSCDE_TOOLSDIR}\/generate_subpanels/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/libexec\/generate_subpanels/\$NSCDE_TOOLSDIR\/generate_subpanels/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/libexec\/generate_subpanels/\$\[NSCDE_TOOLSDIR\]\/generate_subpanels/g' -o -f - > /tmp/_migrate_tmp0.$$

   cat /tmp/_migrate_tmp0.$$ | $ISED -c 's/\$NSCDE_ROOT\/libexec\/keymenu/\$NSCDE_TOOLSDIR\/keymenu/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/libexec\/keymenu/\${NSCDE_TOOLSDIR}\/keymenu/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/libexec\/keymenu/\$NSCDE_TOOLSDIR\/keymenu/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/libexec\/keymenu/\$\[NSCDE_TOOLSDIR\]\/keymenu/g' -o -f - > /tmp/_migrate_tmp1.$$

   cat /tmp/_migrate_tmp1.$$ | $ISED -c 's/\$NSCDE_ROOT\/libexec\/colorconv\.py/\$NSCDE_TOOLSDIR\/colorconv/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/libexec\/colorconv\.py/\${NSCDE_TOOLSDIR}\/colorconv/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/libexec\/colorconv\.py/\$NSCDE_TOOLSDIR\/colorconv/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/libexec\/colorconv\.py/\$\[NSCDE_TOOLSDIR\]\/colorconv/g' -o -f - > /tmp/_migrate_tmp0.$$

   cat /tmp/_migrate_tmp0.$$ | $ISED -c 's/\$NSCDE_ROOT\/libexec\/geticon\.py/\$NSCDE_TOOLSDIR\/geticon/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/libexec\/geticon\.py/\${NSCDE_TOOLSDIR}\/geticon/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/libexec\/geticon\.py/\$NSCDE_TOOLSDIR\/geticon/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/libexec\/geticon\.py/\$\[NSCDE_TOOLSDIR\]\/geticon/g' -o -f - > /tmp/_migrate_tmp1.$$

   cat /tmp/_migrate_tmp1.$$ | $ISED -c 's/\$NSCDE_ROOT\/libexec\/getla1\.py/\$NSCDE_TOOLSDIR\/getla1/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/libexec\/getla1\.py/\${NSCDE_TOOLSDIR}\/getla1/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/libexec\/getla1\.py/\$NSCDE_TOOLSDIR\/getla1/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/libexec\/getla1\.py/\$\[NSCDE_TOOLSDIR\]\/getla1/g' -o -f - > /tmp/_migrate_tmp0.$$

   cat /tmp/_migrate_tmp0.$$ | $ISED -c 's/\$NSCDE_ROOT\/libexec\/nscde-acpi/\$NSCDE_TOOLSDIR\/acpimgr/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/libexec\/nscde-acpi/\${NSCDE_TOOLSDIR}\/acpimgr/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/libexec\/nscde-acpi/\$NSCDE_TOOLSDIR\/acpimgr/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/libexec\/nscde-acpi/\$\[NSCDE_TOOLSDIR\]\/acpimgr/g' -o -f - > /tmp/_migrate_tmp1.$$

   cat /tmp/_migrate_tmp1.$$ | $ISED -c 's/\$NSCDE_ROOT\/libexec\/nscde_get_logical_screens/\$NSCDE_TOOLSDIR\/get_logical_screens/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/libexec\/nscde_get_logical_screens/\${NSCDE_TOOLSDIR}\/get_logical_screens/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/libexec\/nscde_get_logical_screens/\$NSCDE_TOOLSDIR\/get_logical_screens/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/libexec\/nscde_get_logical_screens/\$\[NSCDE_TOOLSDIR\]\/get_logical_screens/g' -o -f - > /tmp/_migrate_tmp0.$$

   cat /tmp/_migrate_tmp0.$$ | $ISED -c 's/\$NSCDE_ROOT\/libexec\/nscde_palette_colorgen\.py/\$NSCDE_TOOLSDIR\/palette_colorgen/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/libexec\/nscde_palette_colorgen\.py/\${NSCDE_TOOLSDIR}\/palette_colorgen/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/libexec\/nscde_palette_colorgen\.py/\$NSCDE_TOOLSDIR\/palette_colorgen/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/libexec\/nscde_palette_colorgen\.py/\$\[NSCDE_TOOLSDIR\]\/palette_colorgen/g' -o -f - > /tmp/_migrate_tmp1.$$

   cat /tmp/_migrate_tmp1.$$ | $ISED -c 's/\$NSCDE_ROOT\/libexec\/nscde_setup/\$NSCDE_TOOLSDIR\/bootstrap/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/libexec\/nscde_setup/\${NSCDE_TOOLSDIR}\/bootstrap/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/libexec\/nscde_setup/\$NSCDE_TOOLSDIR\/bootstrap/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/libexec\/nscde_setup/\$\[NSCDE_TOOLSDIR\]\/bootstrap/g' -o -f - > /tmp/_migrate_tmp0.$$

   cat /tmp/_migrate_tmp0.$$ | $ISED -c 's/\$NSCDE_ROOT\/libexec\/strip_icon_path/\$NSCDE_TOOLSDIR\/strip_icon_path/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/libexec\/strip_icon_path/\${NSCDE_TOOLSDIR}\/strip_icon_path/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/libexec\/strip_icon_path/\$NSCDE_TOOLSDIR\/strip_icon_path/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/libexec\/strip_icon_path/\$\[NSCDE_TOOLSDIR\]\/strip_icon_path/g' -o -f - > /tmp/_migrate_tmp1.$$

   cat /tmp/_migrate_tmp1.$$ | $ISED -c 's/\$NSCDE_ROOT\/libexec\/style_managers\.shlib/\$NSCDE_TOOLSDIR\/style_managers\.shlib/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/libexec\/style_managers\.shlib/\${NSCDE_TOOLSDIR}\/style_managers\.shlib/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/libexec\/style_managers\.shlib/\$NSCDE_TOOLSDIR\/style_managers\.shlib/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/libexec\/style_managers\.shlib/\$\[NSCDE_TOOLSDIR\]\/style_managers\.shlib/g' -o -f - > /tmp/_migrate_tmp0.$$

   cat /tmp/_migrate_tmp0.$$ | $ISED -c 's/\$NSCDE_ROOT\/libexec\/subpanel_menuitem_props/\$NSCDE_TOOLSDIR\/subpanel_menuitem_props/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/libexec\/subpanel_menuitem_props/\${NSCDE_TOOLSDIR}\/subpanel_menuitem_props/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/libexec\/subpanel_menuitem_props/\$NSCDE_TOOLSDIR\/subpanel_menuitem_props/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/libexec\/subpanel_menuitem_props/\$\[NSCDE_TOOLSDIR\]\/subpanel_menuitem_props/g' -o -f - > /tmp/_migrate_tmp1.$$

   cat /tmp/_migrate_tmp1.$$ | $ISED -c 's/\$NSCDE_ROOT\/libexec\/themegen.py/\$NSCDE_TOOLSDIR\/themegen/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/libexec\/themegen.py/\${NSCDE_TOOLSDIR}\/themegen/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/libexec\/themegen.py/\$NSCDE_TOOLSDIR\/themegen/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/libexec\/themegen.py/\$\[NSCDE_TOOLSDIR\]\/themegen/g' -o -f - > /tmp/_migrate_tmp0.$$

   cat /tmp/_migrate_tmp0.$$ | $ISED -c 's/\$NSCDE_ROOT\/libexec\/xrandr_backer/\$NSCDE_TOOLSDIR\/xrandr_backer/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/libexec\/xrandr_backer/\${NSCDE_TOOLSDIR}\/xrandr_backer/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/libexec\/xrandr_backer/\$NSCDE_TOOLSDIR\/xrandr_backer/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/libexec\/xrandr_backer/\$\[NSCDE_TOOLSDIR\]\/xrandr_backer/g' -o -f - > /tmp/_migrate_tmp1.$$

   # Share paths
   cat /tmp/_migrate_tmp1.$$ | $ISED -c 's/\$NSCDE_ROOT\/share\/config_templates\/integration/\$NSCDE_DATADIR\/integration/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/share\/config_templates\/integration/\${NSCDE_DATADIR}\/integration/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/share\/config_templates\/integration/\$NSCDE_DATADIR\/integration/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/share\/config_templates\/integration/\$\[NSCDE_DATADIR\]\/integration/g' -o -f - > /tmp/_migrate_tmp0.$$

   cat /tmp/_migrate_tmp0.$$ | $ISED -c 's/\$NSCDE_ROOT\/share\/config_templates/\$NSCDE_DATADIR\/config_templates/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/share\/config_templates/\${NSCDE_DATADIR}\/config_templates/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/share\/config_templates/\$NSCDE_DATADIR\/config_templates/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/share\/config_templates/\$\[NSCDE_DATADIR\]\/config_templates/g' -o -f - > /tmp/_migrate_tmp1.$$

   cat /tmp/_migrate_tmp1.$$ | $ISED -c 's/\$NSCDE_ROOT\/share\/palettes/\$NSCDE_DATADIR\/palettes/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/share\/palettes/\${NSCDE_DATADIR}\/palettes/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/share\/palettes/\$NSCDE_DATADIR\/palettes/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/share\/palettes/\$\[NSCDE_DATADIR\]\/palettes/g' -o -f - > /tmp/_migrate_tmp0.$$

   cat /tmp/_migrate_tmp0.$$ | $ISED -c 's/\$NSCDE_ROOT\/share\/backdrops/\$NSCDE_DATADIR\/backdrops/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/share\/backdrops/\${NSCDE_DATADIR}\/backdrops/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/share\/backdrops/\$NSCDE_DATADIR\/backdrops/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/share\/backdrops/\$\[NSCDE_DATADIR\]\/backdrops/g' -o -f - > /tmp/_migrate_tmp1.$$

   cat /tmp/_migrate_tmp1.$$ | $ISED -c 's/\$NSCDE_ROOT\/share\/photos/\$NSCDE_DATADIR\/photos/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/share\/photos/\${NSCDE_DATADIR}\/photos/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/share\/photos/\$NSCDE_DATADIR\/photos/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/share\/photos/\$\[NSCDE_DATADIR\]\/photos/g' -o -f - > /tmp/_migrate_tmp0.$$

   # Scripts
   cat /tmp/_migrate_tmp0.$$ | $ISED -c 's/\$NSCDE_ROOT\/lib\/scripts/\$NSCDE_LIBDIR\/scripts/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/lib\/scripts/\${NSCDE_LIBDIR}\/scripts/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/lib\/scripts/\$NSCDE_LIBDIR\/scripts/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/lib\/scripts/\$\[NSCDE_LIBDIR\]\/scripts/g' -o -f - > /tmp/_migrate_tmp1.$$

   # Config
   cat /tmp/_migrate_tmp1.$$ | $ISED -c 's/\$NSCDE_ROOT\/config\/AppMenus\.conf/\$NSCDE_DATADIR\/defaults\/AppMenus\.conf/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/config\/AppMenus\.conf/\${NSCDE_DATADIR}\/defaults\/AppMenus\.conf/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/config\/AppMenus\.conf/\$NSCDE_DATADIR\/defaults\/AppMenus\.conf/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/config\/AppMenus\.conf/\$\[NSCDE_DATADIR\]\/defaults\/AppMenus\.conf/g' -o -f - > /tmp/_migrate_tmp0.$$

   cat /tmp/_migrate_tmp0.$$ | $ISED -c 's/\$NSCDE_ROOT\/config\/FrontPanel\.actions/\$NSCDE_DATADIR\/defaults\/FrontPanel\.actions/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/config\/FrontPanel\.actions/\${NSCDE_DATADIR}\/defaults\/FrontPanel\.actions/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/config\/FrontPanel\.actions/\$NSCDE_DATADIR\/defaults\/FrontPanel\.actions/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/config\/FrontPanel\.actions/\$\[NSCDE_DATADIR\]\/defaults\/FrontPanel\.actions/g' -o -f - > /tmp/_migrate_tmp1.$$

   cat /tmp/_migrate_tmp1.$$ | $ISED -c 's/\$NSCDE_ROOT\/config\/Keymenu\.actions/\$NSCDE_DATADIR\/defaults\/Keymenu\.actions/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/config\/Keymenu\.actions/\${NSCDE_DATADIR}\/defaults\/Keymenu\.actions/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/config\/Keymenu\.actions/\$NSCDE_DATADIR\/defaults\/Keymenu\.actions/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/config\/Keymenu\.actions/\$\[NSCDE_DATADIR\]\/defaults\/Keymenu\.actions/g' -o -f - > /tmp/_migrate_tmp0.$$

   cat /tmp/_migrate_tmp0.$$ | $ISED -c 's/\$NSCDE_ROOT\/config\/Subpanels\.actions/\$NSCDE_DATADIR\/defaults\/Subpanels\.actions/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/config\/Subpanels\.actions/\${NSCDE_DATADIR}\/defaults\/Subpanels\.actions/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/config\/Subpanels\.actions/\$NSCDE_DATADIR\/defaults\/Subpanels\.actions/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/config\/Subpanels\.actions/\$\[NSCDE_DATADIR\]\/defaults\/Subpanels\.actions/g' -o -f - > /tmp/_migrate_tmp1.$$

   cat /tmp/_migrate_tmp1.$$ | $ISED -c 's/\$NSCDE_ROOT\/config\/WSM\.conf/\$NSCDE_DATADIR\/defaults\/WSM\.conf/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/config\/WSM\.conf/\${NSCDE_DATADIR}\/defaults\/WSM\.conf/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/config\/WSM\.conf/\$NSCDE_DATADIR\/defaults\/WSM\.conf/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/config\/WSM\.conf/\$\[NSCDE_DATADIR\]\/defaults\/WSM\.conf/g' -o -f - > /tmp/_migrate_tmp0.$$

   cat /tmp/_migrate_tmp0.$$ | $ISED -c 's/\$NSCDE_ROOT\/config/\$NSCDE_DATADIR\/fvwm/g' -o -f - | \
   $ISED -c 's/\${NSCDE_ROOT}\/config/\${NSCDE_DATADIR}\/fvwm/g' -o -f - | \
   $ISED -c 's/\/opt\/NsCDE\/config/\$NSCDE_DATADIR\/fvwm/g' -o -f - | \
   $ISED -c 's/\$\[NSCDE_ROOT\]\/config/\$\[NSCDE_DATADIR\]\/fvwm/g' -o -f - > /tmp/_migrate_tmp1.$$

   mv -f /tmp/_migrate_tmp1.$$ $1
   rm -f /tmp/_migrate_tmp0.$$
}

function replace_confnames_in_files {
   old_confs_escaped="NsCDE-Backer\.conf NsCDE-Event\.conf NsCDE-FinishInit\.conf NsCDE-Form\.conf NsCDE-FrontPanel\.conf NsCDE-Functions\.conf NsCDE-IconMan\.conf NsCDE-Ident\.conf NsCDE-Init\.conf NsCDE-Keybindings\.conf NsCDE-Main\.conf NsCDE-Menus\.conf NsCDE-Monitors\.conf NsCDE-Mousebindings\.conf NsCDE-Pager-LocalPager\.conf NsCDE-Pager-WspLocPager\.conf NsCDE-Sandbox\.conf NsCDE-Script\.conf NsCDE-Style\.conf"

   old_genconfs_escaped="NsCDE-Animate\.conf NsCDE-Backdrops\.conf NsCDE-Colorset\.conf NsCDE-Font-120dpi\.conf NsCDE-Font-144dpi\.conf NsCDE-Font-192dpi\.conf NsCDE-Font-75dpi\.conf NsCDE-Font-96dpi\.conf"

   old_locals_escaped="NsCDE-Animate\.local NsCDE-Backdrops\.local NsCDE-Backer\.local NsCDE-Colorset\.local NsCDE-Event\.local NsCDE-FinishInit\.local NsCDE-Font-120dpi\.local NsCDE-Font-144dpi\.local NsCDE-Font-192dpi\.local NsCDE-Font-75dpi\.local NsCDE-Font-96dpi\.local NsCDE-Form\.local NsCDE-FrontPanel\.local NsCDE-Functions\.local NsCDE-IconMan\.local NsCDE-Ident\.local NsCDE-Init\.local NsCDE-Keybindings\.local NsCDE-Main\.local NsCDE-Menus\.local NsCDE-Monitors\.local NsCDE-Mousebindings\.local NsCDE-Pager-LocalPager\.local NsCDE-Pager-WspLocPager\.local NsCDE-Sandbox\.local NsCDE-Script\.local NsCDE-Style\.local NsCDE-Subpanels\.local"

   for oce in $old_confs_escaped
   do
      oce_new=$(echo "${oce}" | sed 's/^NsCDE-//g; s/\.conf/\.fvwmconf/g')
      echo "Changing ${oce} occurences to ${oce_new} in all regular files inside ~/.NsCDE"
      find . -xdev -type f ! -name "*.xpm" ! -name "*.png" ! -name "*.pm" ! -name "*.log" ! -name .BGdefault ! -name .Exec-History ! -name "*.pid" -exec $ISED -c "s/${oce}/${oce_new}/g" -f {} \;
   done

   for oge in $old_genconfs_escaped
   do
      oge_new=$(echo "${oge}" | sed 's/^NsCDE-//g; s/\.conf/\.fvwmgen/g')
      echo "Changing ${oge} occurences to ${oge_new} in all regular files inside ~/.NsCDE"
      find . -xdev -type f ! -name "*.xpm" ! -name "*.png" ! -name "*.pm" ! -name "*.log" ! -name .BGdefault ! -name .Exec-History ! -name "*.pid" -exec $ISED -c "s/${oge}/${oge_new}/g" -f {} \;
   done

   for ole in $old_locals_escaped
   do
      ole_new=$(echo "${ole}" | sed 's/^NsCDE-//g; s/\.local/\.fvwmlocal/g')
      echo "Changing ${ole} occurences to ${ole_new} in all regular files inside ~/.NsCDE"
      find . -xdev -type f ! -name "*.xpm" ! -name "*.png" ! -name "*.pm" ! -name "*.log" ! -name .BGdefault ! -name .Exec-History ! -name "*.pid" -exec $ISED -c "s/${ole}/${ole_new}/g" -f {} \;
   done
}

function walk_and_change_pathnames_in_files
{
   files_to_process=$(find . -xdev -type f ! -name "*.xpm" ! -name "*.png" ! -name "*.pm" ! -name "*.jpg" \
 ! -name "*.jpeg" ! -name "*.svg" ! -name "*.log" ! -name .BGdefault ! -name ".Exec-History" \
 ! -name "*.pid" ! -name "*.old" ! -name "Xdefaults*" ! -name "*SysActionDialog.lastval" \
 ! -name "WSM.conf" ! -name "Xsettingsd.conf" ! -name "GeoDB.ini" ! -name "Stalonetray.conf" \
 ! -name NsCDE-Subpanels.conf ! -name "*.fontset" ! -name ".FvwmConsole-History" \
 ! -name "*Font-*.fvwmgen" ! -name NsCDE.rasi | \
 egrep -v '\.\/(app-defaults|templates\/app-defaults|palettes|backdrops|photos|icons\/\.theme)\/')

   for ftp in $files_to_process
   do
      echo "Processing $ftp with pathname replacements for NsCDE 2.0"
      replace_pathnames_in_files "$ftp"
   done
}

rename_config_files
replace_confnames_in_files
walk_and_change_pathnames_in_files

